services:
  # ===========================================
  # Infrastructure Services
  # ===========================================
  
  postgres:
    image: pgvector/pgvector:pg16
    container_name: postgres-spring-dev
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-osint_db}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=C"
    volumes:
      - postgres-spring-data:/var/lib/postgresql/data
      - ./infra/db/postgres/init-osint.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - spring-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7-alpine
    container_name: redis-spring-dev
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-spring-data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - spring-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  consul:
    image: consul:1.15
    container_name: consul-spring-dev
    restart: unless-stopped
    command: agent -server -bootstrap-expect=1 -ui -client=0.0.0.0 -bind=0.0.0.0
    environment:
      CONSUL_BIND_INTERFACE: eth0
    volumes:
      - consul-spring-data:/consul/data
      - consul-spring-config:/consul/config
    ports:
      - "${CONSUL_HTTP_PORT:-8500}:8500"
      - "${CONSUL_DNS_PORT:-8600}:8600/udp"
      - "${CONSUL_SERVER_PORT:-8300}:8300"
    networks:
      - spring-network
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  consul-kv-init:
    image: curlimages/curl:8.5.0
    container_name: consul-kv-init
    depends_on:
      consul:
        condition: service_healthy
    environment:
      CONSUL_HTTP_ADDR: http://consul:8500
      CONSUL_HTTP_TOKEN: ${CONSUL_HTTP_TOKEN:-}
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-}
      CHANGEDETECTION_API_KEY: ${CHANGEDETECTION_API_KEY:-}
    networks:
      - spring-network
    volumes:
      - ./init-scripts/consul:/scripts:ro
    restart: "no"
    command:
      - /bin/sh
      - /scripts/seed-kv.sh

  changedetection-seed:
    image: curlimages/curl:8.5.0
    container_name: changedetection-seed
    depends_on:
      changedetection:
        condition: service_started
    environment:
      CHANGEDETECTION_BASE_URL: ${CHANGEDETECTION_BASE_URL:-http://changedetection:5000}
      CHANGEDETECTION_API_KEY: ${CHANGEDETECTION_API_KEY:-}
      CHANGEDETECTION_DEFAULT_TAG: ${CHANGEDETECTION_DEFAULT_TAG:-news}
    networks:
      - spring-network
    volumes:
      - ./init-scripts/changedetection:/scripts:ro
    restart: "no"
    command:
      - /bin/sh
      - /scripts/seed-watches.sh

  crawl4ai:
    image: capstone/crawl4ai:local
    build:
      context: ./services/python/crawl-worker
      dockerfile: Dockerfile
    container_name: crawl4ai
    restart: unless-stopped
    networks:
      - spring-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================
  # Spring Boot Microservices
  # ===========================================
  
  api-gateway:
    image: pension/api-gateway:local
    build:
      context: ./services/java
      dockerfile: gateway/Dockerfile
    container_name: api-gateway-spring
    restart: unless-stopped
    environment:
      # Spring Configuration
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-dev}
      PORT: ${GATEWAY_PORT:-8080}
      
      # Service URLs (using ENV format matching Spring Boot config)
      SERVICES_COLLECTOR_URL: http://collector-service:8002
      SERVICES_ANALYSIS_URL: http://analysis-service:8001
      SERVICES_ABSA_URL: http://absa-service:8003
      SERVICES_ALERT_URL: http://alert-service:8004
      SERVICES_OSINT_ORCHESTRATOR_URL: http://osint-orchestrator:8005
      SERVICES_OSINT_PLANNING_URL: http://osint-planning:8006
      SERVICES_OSINT_SOURCE_URL: http://osint-source:8007
      
      # Consul Configuration (disabled for now due to Spring Cloud compatibility)
      SPRING_CLOUD_CONSUL_ENABLED: ${CONSUL_ENABLED:-false}
      SPRING_CLOUD_CONSUL_HOST: ${CONSUL_HOST:-consul}
      SPRING_CLOUD_CONSUL_PORT: ${CONSUL_PORT:-8500}
      SPRING_CLOUD_CONSUL_DISCOVERY_ENABLED: ${CONSUL_DISCOVERY_ENABLED:-false}
      SPRING_CLOUD_CONSUL_CONFIG_ENABLED: ${CONSUL_CONFIG_ENABLED:-false}
      SPRING_CLOUD_COMPATIBILITY_VERIFIER_ENABLED: false
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "${GATEWAY_PORT:-8080}:${GATEWAY_PORT:-8080}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      analysis-service:
        condition: service_started
      collector-service:
        condition: service_started
      absa-service:
        condition: service_started
      alert-service:
        condition: service_started
    networks:
      - spring-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${GATEWAY_PORT:-8080}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  collector-service:
    image: pension/collector-service:local
    build:
      context: ./services/java
      dockerfile: collector/Dockerfile
    container_name: collector-service-spring
    restart: unless-stopped
    environment:
      # Spring Configuration
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-dev}
      PORT: 8002
      
      # Database Configuration
      DB_URL: jdbc:postgresql://postgres:5432/${DB_NAME:-osint_db}
      DB_USERNAME: ${DB_USER:-osint_user}
      DB_PASSWORD: ${DB_PASSWORD:-osint_password}
      
      # Consul Configuration (disabled for now)
      SPRING_CLOUD_CONSUL_ENABLED: ${CONSUL_ENABLED:-false}
      SPRING_CLOUD_CONSUL_HOST: ${CONSUL_HOST:-consul}
      SPRING_CLOUD_CONSUL_PORT: ${CONSUL_PORT:-8500}
      SPRING_CLOUD_CONSUL_DISCOVERY_ENABLED: ${CONSUL_DISCOVERY_ENABLED:-false}
      SPRING_CLOUD_COMPATIBILITY_VERIFIER_ENABLED: false
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      # Crawl4AI sidecar URL (internal DNS)
      CRAWL4AI_URL: http://crawl4ai:8001
    ports:
      - "8002:8002"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      crawl4ai:
        condition: service_healthy
    networks:
      - spring-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8002/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  analysis-service:
    image: pension/analysis-service:local
    build:
      context: ./services/java
      dockerfile: analysis/Dockerfile
    container_name: analysis-service-spring
    restart: unless-stopped
    environment:
      # Spring Configuration
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-dev}
      PORT: 8001
      
      # Database Configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-osint_db}
      DB_USER: ${DB_USER:-osint_user}
      DB_PASSWORD: ${DB_PASSWORD:-osint_password}
      HIBERNATE_DDL_AUTO: ${HIBERNATE_DDL_AUTO:-update}
      
      # Consul Configuration (disabled for now)
      SPRING_CLOUD_CONSUL_ENABLED: ${CONSUL_ENABLED:-false}
      SPRING_CLOUD_CONSUL_HOST: ${CONSUL_HOST:-consul}
      SPRING_CLOUD_CONSUL_PORT: ${CONSUL_PORT:-8500}
      SPRING_CLOUD_CONSUL_DISCOVERY_ENABLED: ${CONSUL_DISCOVERY_ENABLED:-false}
      SPRING_CLOUD_COMPATIBILITY_VERIFIER_ENABLED: false
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      HIBERNATE_LOG_LEVEL: ${HIBERNATE_LOG_LEVEL:-INFO}
    ports:
      - "8001:8001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      consul-kv-init:
        condition: service_completed_successfully
      changedetection-seed:
        condition: service_completed_successfully
    networks:
      - spring-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8001/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  absa-service:
    image: pension/absa-service:local
    build:
      context: ./services/java
      dockerfile: absa/Dockerfile
    container_name: absa-service-spring
    restart: unless-stopped
    environment:
      # Spring Configuration
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-dev}
      PORT: 8003
      
      # Database Configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-osint_db}
      DB_USER: ${DB_USER:-osint_user}
      DB_PASSWORD: ${DB_PASSWORD:-osint_password}
      HIBERNATE_DDL_AUTO: ${HIBERNATE_DDL_AUTO:-update}
      
      # Consul Configuration (disabled for now)
      SPRING_CLOUD_CONSUL_ENABLED: ${CONSUL_ENABLED:-false}
      SPRING_CLOUD_CONSUL_HOST: ${CONSUL_HOST:-consul}
      SPRING_CLOUD_CONSUL_PORT: ${CONSUL_PORT:-8500}
      SPRING_CLOUD_CONSUL_DISCOVERY_ENABLED: ${CONSUL_DISCOVERY_ENABLED:-false}
      SPRING_CLOUD_COMPATIBILITY_VERIFIER_ENABLED: false
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      HIBERNATE_LOG_LEVEL: ${HIBERNATE_LOG_LEVEL:-INFO}
    ports:
      - "8003:8003"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - spring-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8003/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  alert-service:
    image: pension/alert-service:local
    build:
      context: ./services/java
      dockerfile: alert/Dockerfile
    container_name: alert-service-spring
    restart: unless-stopped
    environment:
      # Spring Configuration
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-dev}
      PORT: 8004

      # Database Configuration
      DATABASE_URL: jdbc:postgresql://postgres:5432/${DB_NAME:-osint_db}
      DATABASE_USER: ${DB_USER:-osint_user}
      DATABASE_PASSWORD: ${DB_PASSWORD:-osint_password}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "8004:8004"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - spring-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8004/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  frontend-dashboard:
    image: pension/frontend-dashboard:local
    build:
      context: ./FRONTEND-DASHBOARD
      dockerfile: Dockerfile
      args:
        REACT_APP_API_URL: /api
    container_name: frontend-dashboard-spring
    restart: unless-stopped
    environment:
      # Runtime fallback; built assets already bake API URL via build arg
      VITE_API_GATEWAY_URL: http://api-gateway:${GATEWAY_PORT:-8080}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    depends_on:
      api-gateway:
        condition: service_started
    networks:
      - spring-network

  swagger-ui:
    image: swaggerapi/swagger-ui:latest
    container_name: swagger-ui
    restart: unless-stopped
    volumes:
      # Swagger UI 초기화 스크립트가 /usr/share/nginx/html/openapi.yaml로 사본을 만들도록,
      # 호스트 스펙 파일은 별도의 경로(/openapi/openapi.yaml)에 마운트합니다.
      - ./openapi-consolidated.yaml:/openapi/openapi.yaml:ro
    environment:
      # 컨테이너 내부의 스펙 위치를 원본(/openapi/openapi.yaml)로 지정
      SWAGGER_JSON: /openapi/openapi.yaml
    ports:
      - "9000:8080"
    depends_on:
      api-gateway:
        condition: service_started
    networks:
      - spring-network

  changedetection:
    image: ghcr.io/dgtlmoon/changedetection.io
    container_name: changedetection
    restart: unless-stopped
    volumes:
      - changedetection-data:/datastore
    environment:
      - PLAYWRIGHT_DRIVER_URL=ws://playwright:3000
    ports:
      - "5000:5000"
    depends_on:
      - playwright
    networks:
      - spring-network

  playwright:
    image: browserless/chrome
    container_name: playwright
    restart: unless-stopped
    expose:
      - "3000"
    networks:
      - spring-network

networks:
  spring-network:
    driver: bridge
    name: spring-dev-network

volumes:
  postgres-spring-data:
  redis-spring-data:
  consul-spring-data:
  consul-spring-config:
  changedetection-data:
