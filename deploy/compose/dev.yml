version: "3.9"

# Local development overrides: adds infrastructure and host port bindings.
# Usage: docker compose -f deploy/compose/compose.yml -f deploy/compose/dev.yml up -d

services:
  postgres:
    image: pgvector/pgvector:pg16
    container_name: postgres-dev
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-osint_db}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./infra/db/postgres/init-osint.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - capstone-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7-alpine
    container_name: redis-dev
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - capstone-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  consul:
    image: consul:1.15
    container_name: consul-dev
    restart: unless-stopped
    command: agent -server -bootstrap-expect=1 -ui -client=0.0.0.0 -bind=0.0.0.0
    environment:
      CONSUL_BIND_INTERFACE: eth0
    volumes:
      - consul-data:/consul/data
      - consul-config:/consul/config
    ports:
      - "${CONSUL_HTTP_PORT:-8500}:8500"
      - "${CONSUL_DNS_PORT:-8600}:8600/udp"
      - "${CONSUL_SERVER_PORT:-8300}:8300"
    networks:
      - capstone-net
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  mongodb:
    image: mongo:6.0
    container_name: mongodb-dev
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    networks:
      - capstone-net

  pgvector:
    image: pgvector/pgvector:pg16
    container_name: pgvector-dev
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${VECTOR_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${VECTOR_DB_PASSWORD:-postgres}
      POSTGRES_DB: ${VECTOR_DB_NAME:-vectors}
    ports:
      - "${VECTOR_DB_PORT:-7432}:5432"
    volumes:
      - pgvector-data:/var/lib/postgresql/data
      - ./DOCKER/pgvector/init.sql:/docker-entrypoint-initdb.d/00-init.sql:ro
    networks:
      - capstone-net

  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v24.1.6
    container_name: redpanda-dev
    restart: unless-stopped
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp
      - "1"
      - --memory
      - 1G
      - --reserve-memory
      - 0M
      - --node-id
      - "0"
      - --check=false
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:9092,OUTSIDE://0.0.0.0:19092
      - --advertise-kafka-addr
      - PLAINTEXT://redpanda:9092,OUTSIDE://localhost:19092
    ports:
      - "9092:9092"
      - "19092:19092"
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    networks:
      - capstone-net

  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:v2.7.1
    container_name: redpanda-console-dev
    restart: unless-stopped
    environment:
      KAFKA_BROKERS: redpanda:9092
    depends_on:
      - redpanda
    ports:
      - "8080:8080"
    networks:
      - capstone-net

  api-gateway:
    ports:
      - "${GATEWAY_PORT:-8080}:8080"
    environment:
      SERVICES_COLLECTOR_URL: http://collector-service:8002
      SERVICES_ANALYSIS_URL: http://analysis-service:8001
      SERVICES_ABSA_URL: http://absa-service:8003
      # Example additional service URLs can be appended here.
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      analysis-service:
        condition: service_started
      collector-service:
        condition: service_started
      absa-service:
        condition: service_started

  analysis-service:
    ports:
      - "8001:8001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  collector-service:
    ports:
      - "8002:8002"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  absa-service:
    ports:
      - "8003:8003"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  frontend-dashboard:
    ports:
      - "5173:5173"
    environment:
      VITE_API_GATEWAY_URL: http://localhost:${GATEWAY_PORT:-8080}

networks:
  capstone-net:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
  consul-data:
  consul-config:
  mongo-data:
  pgvector-data:
  redpanda-data:
