groups:
  - name: hybrid_crawler_alerts
    interval: 30s
    rules:
      # System Alerts
      - alert: HighCPUUsage
        expr: system_cpu_usage_percent > 80
        for: 5m
        labels:
          severity: warning
          service: hybrid-crawler
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is {{ $value }}% for more than 5 minutes"

      - alert: HighMemoryUsage
        expr: (system_memory_usage_bytes / system_memory_total_bytes) * 100 > 90
        for: 5m
        labels:
          severity: critical
          service: hybrid-crawler
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is {{ $value }}% for more than 5 minutes"

      # API Alerts
      - alert: HighAPIErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          service: hybrid-crawler
        annotations:
          summary: "High API error rate"
          description: "API error rate is {{ $value | humanizePercentage }} for endpoint {{ $labels.endpoint }}"

      - alert: HighAPILatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 10m
        labels:
          severity: warning
          service: hybrid-crawler
        annotations:
          summary: "High API latency"
          description: "95th percentile latency is {{ $value }}s for endpoint {{ $labels.endpoint }}"

      # Task Alerts
      - alert: HighTaskFailureRate
        expr: rate(tasks_total{status="failed"}[5m]) > rate(tasks_total{status="completed"}[5m])
        for: 10m
        labels:
          severity: critical
          service: hybrid-crawler
        annotations:
          summary: "High task failure rate"
          description: "Task failure rate ({{ $value }}) is higher than success rate"

      - alert: TooManyActiveTasks
        expr: tasks_active > 100
        for: 5m
        labels:
          severity: warning
          service: hybrid-crawler
        annotations:
          summary: "Too many active tasks"
          description: "{{ $value }} active tasks detected"

      # Database Alerts
      - alert: HighDatabaseConnections
        expr: db_connections_active > 40
        for: 5m
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: "High database connections"
          description: "Active database connections: {{ $value }}"

      - alert: SlowDatabaseQueries
        expr: histogram_quantile(0.95, rate(db_query_duration_seconds_bucket[5m])) > 1
        for: 10m
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: "Slow database queries"
          description: "95th percentile query time is {{ $value }}s for operation {{ $labels.operation }}"

      # Cache Alerts
      - alert: LowCacheHitRate
        expr: |
          sum(rate(cache_hits_total[5m])) / 
          (sum(rate(cache_hits_total[5m])) + sum(rate(cache_misses_total[5m]))) < 0.5
        for: 15m
        labels:
          severity: info
          service: redis
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }}"

      # Scraping Alerts
      - alert: HighScrapingFailureRate
        expr: |
          sum(rate(scraping_requests_total{status="failed"}[5m])) / 
          sum(rate(scraping_requests_total[5m])) > 0.3
        for: 10m
        labels:
          severity: warning
          service: hybrid-crawler
        annotations:
          summary: "High scraping failure rate"
          description: "Scraping failure rate is {{ $value | humanizePercentage }}"

      # Service Health
      - alert: ServiceDown
        expr: up{job="hybrid-crawler"} == 0
        for: 1m
        labels:
          severity: critical
          service: hybrid-crawler
        annotations:
          summary: "Service is down"
          description: "Hybrid Crawler service has been down for more than 1 minute"
